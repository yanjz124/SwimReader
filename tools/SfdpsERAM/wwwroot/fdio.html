<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FDIO | swim.vncrcc.org</title>
<style>
@font-face { font-family: 'ERAM'; src: url('ERAMv110.ttf') format('truetype'); }
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'ERAM', 'Consolas', 'Courier New', monospace;
    background: #000;
    color: #ccc;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* ── Top bar ──────────────────────────────────────────────── */
.topbar {
    background: #0a0a0a;
    border-bottom: 1px solid #333;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
}
.topbar h1 { font-size: 15px; color: #cccc44; font-weight: normal; letter-spacing: 2px; }
.status { font-size: 11px; color: #666; }
.status.ok { color: #44aa44; }
.stats { font-size: 11px; color: #888; margin-left: auto; }

/* ── Filter bar ───────────────────────────────────────────── */
.filterbar {
    background: #0a0a0a;
    border-bottom: 1px solid #333;
    padding: 6px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
    flex-wrap: wrap;
}
.search-box {
    background: #111;
    border: 1px solid #333;
    border-radius: 2px;
    padding: 4px 10px;
    font-size: 12px;
    font-family: inherit;
    color: #ccc;
    width: 280px;
    outline: none;
}
.search-box:focus { border-color: #cccc44; }
.search-box::placeholder { color: #555; }
.filter-label { font-size: 10px; color: #666; letter-spacing: 1px; }
.filter-select {
    background: #111;
    border: 1px solid #333;
    border-radius: 2px;
    padding: 3px 6px;
    font-size: 11px;
    font-family: inherit;
    color: #ccc;
    outline: none;
}
.filter-select:focus { border-color: #cccc44; }
.filter-sep { width: 1px; height: 18px; background: #333; }
.result-count { font-size: 11px; color: #555; }

/* ── Main split layout ───────────────────────────────────── */
.main {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* ── Flight list (left panel) ────────────────────────────── */
.flight-list {
    flex: 1;
    overflow-y: auto;
    min-width: 0;
}

/* Column header */
.col-header {
    display: grid;
    grid-template-columns: 90px 50px 46px 46px 60px 46px 24px 70px 50px 26px 24px;
    gap: 6px;
    padding: 6px 12px;
    font-size: 10px;
    color: #555;
    letter-spacing: 1px;
    border-bottom: 1px solid #222;
    background: #050505;
    position: sticky;
    top: 0;
    z-index: 2;
    cursor: pointer;
    user-select: none;
}
.col-header span:hover { color: #cccc44; }
.col-header .sorted { color: #cccc44; }

/* Flight row */
.flight-row {
    display: grid;
    grid-template-columns: 90px 50px 46px 46px 60px 46px 24px 70px 50px 26px 24px;
    gap: 6px;
    padding: 5px 12px;
    font-size: 12px;
    border-bottom: 1px solid #111;
    cursor: pointer;
    transition: background 0.1s;
}
.flight-row:hover { background: #0a0a0a; }
.flight-row.selected { background: #0a1a0a; border-left: 2px solid #44aa44; }
.flight-row .cs { color: #fff; }
.flight-row .dep, .flight-row .arr { color: #888; }
.flight-row .alt { color: #39d2c0; }
.flight-row .alt.vfr { color: #cccc44; }
.flight-row .int { color: #ff8844; }
.flight-row .rules { color: #888; }
.flight-row .sector { color: #5588ff; }
.flight-row .sqk { color: #888; }
.flight-row .dl { font-size: 10px; }
.flight-row .dl.yes { color: #44aa44; }
.flight-row .dl.no { color: #333; }
.flight-row .st { width: 8px; height: 8px; border-radius: 50%; margin-top: 3px; }
.flight-row .st.active { background: #44aa44; }
.flight-row .st.dropped { background: #ff4444; }
.flight-row .st.cancelled { background: #555; }
.flight-row .st.historical { background: #444; }
.flight-row.historical { opacity: 0.5; }
.flight-row.historical:hover { opacity: 0.75; }
.flight-row.historical.selected { opacity: 0.75; }
.purge-banner {
    background: #1a1000;
    border: 1px solid #665500;
    color: #cccc44;
    font-size: 11px;
    padding: 6px 12px;
    margin-bottom: 10px;
    letter-spacing: 1px;
    text-align: center;
}
.detail-header .status-badge.historical { background: #1a1a00; color: #888; border: 1px solid #555; }

/* ── Detail panel (right) ────────────────────────────────── */
.detail-panel {
    width: 440px;
    background: #050505;
    border-left: 1px solid #333;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: width 0.2s;
    flex-shrink: 0;
}
.detail-panel.collapsed { width: 0; border: none; }

.detail-header {
    display: flex;
    align-items: center;
    padding: 8px 14px;
    border-bottom: 1px solid #333;
    gap: 10px;
    flex-shrink: 0;
}
.detail-header .cs-big { font-size: 16px; color: #fff; }
.detail-header .type-badge { color: #888; font-size: 12px; }
.detail-header .status-badge { font-size: 10px; padding: 1px 6px; border-radius: 2px; }
.detail-header .status-badge.active { background: #0a200a; color: #44aa44; border: 1px solid #44aa44; }
.detail-header .status-badge.dropped { background: #200a0a; color: #ff4444; border: 1px solid #ff4444; }
.detail-close {
    margin-left: auto;
    cursor: pointer;
    color: #555;
    font-size: 18px;
    padding: 2px 6px;
}
.detail-close:hover { color: #fff; }

/* Tabs */
.tab-bar {
    display: flex;
    border-bottom: 1px solid #333;
    flex-shrink: 0;
}
.tab {
    padding: 6px 16px;
    font-size: 11px;
    letter-spacing: 1px;
    color: #555;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: color 0.15s;
}
.tab:hover { color: #aaa; }
.tab.active { color: #cccc44; border-bottom-color: #cccc44; }

.detail-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px 14px;
}

/* Detail sections */
.section { margin-bottom: 14px; }
.section h3 {
    font-size: 10px;
    color: #555;
    letter-spacing: 1px;
    margin-bottom: 5px;
    border-bottom: 1px solid #1a1a1a;
    padding-bottom: 3px;
    font-weight: normal;
}
.field-grid {
    display: grid;
    grid-template-columns: 100px 1fr;
    gap: 3px 10px;
    font-size: 12px;
}
.field-label { color: #555; }
.field-value { color: #ccc; word-break: break-all; }
.field-value.hl { color: #39d2c0; }
.field-value.warn { color: #ff8844; }
.field-value.accent { color: #5588ff; }

.route-text {
    font-size: 11px;
    color: #aaa;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.5;
    padding: 5px 8px;
    background: #080808;
    border: 1px solid #1a1a1a;
    border-radius: 2px;
    margin-bottom: 6px;
}

.icao-btn {
    background: #0a200a;
    color: #cccc44;
    border: 1px solid #44aa44;
    padding: 4px 14px;
    font-size: 11px;
    cursor: pointer;
    font-family: inherit;
    margin-bottom: 8px;
}
.icao-btn:hover { background: #0a300a; color: #fff; }
.simbrief-btn { text-decoration: none; display: inline-block; margin-left: 6px; }
.icao-block {
    background: #080808;
    border: 1px solid #333;
    padding: 10px 12px;
    padding-top: 28px;
    font-size: 12px;
    color: #ccc;
    white-space: pre-wrap;
    word-break: break-all;
    line-height: 1.6;
    margin-bottom: 14px;
    position: relative;
}
.icao-copy {
    position: absolute;
    top: 4px;
    right: 4px;
    background: #1a1a1a;
    color: #888;
    border: 1px solid #333;
    padding: 2px 8px;
    font-size: 10px;
    cursor: pointer;
    font-family: inherit;
}
.icao-copy:hover { color: #fff; }

/* Event log (tab 2) */
.event-row {
    padding: 3px 0;
    border-bottom: 1px solid #0a0a0a;
    cursor: pointer;
}
.event-row:hover { background: #0a0a0a; }
.event-row .ev-line {
    display: flex;
    gap: 8px;
    font-size: 11px;
}
.event-row .ev-time { color: #555; min-width: 68px; font-variant-numeric: tabular-nums; }
.event-row .ev-src { min-width: 22px; font-weight: normal; }
.event-row .ev-src.oh, .event-row .ev-src.hp, .event-row .ev-src.ah,
.event-row .ev-src.hu, .event-row .ev-src.hx { color: #5588ff; }
.event-row .ev-src.fh { color: #ccc; }
.event-row .ev-src.th, .event-row .ev-src.hz { color: #333; }
.event-row .ev-src.lh { color: #ff8844; }
.event-row .ev-src.ba, .event-row .ev-src.re { color: #888; }
.event-row .ev-src.pt, .event-row .ev-src.ht { color: #cc44cc; }
.event-row .ev-src.cl { color: #ff4444; }
.event-row .ev-centre { color: #444; min-width: 30px; }
.event-row .ev-summary { color: #aaa; flex: 1; }
.event-row .ev-xml-indicator { color: #333; font-size: 10px; }
.event-row .ev-xml-indicator.has-xml { color: #555; }

/* Raw XML expansion */
.xml-block {
    background: #080808;
    border: 1px solid #1a1a1a;
    border-radius: 2px;
    padding: 6px 8px;
    margin: 4px 0 2px 0;
    font-size: 10px;
    line-height: 1.4;
    max-height: 400px;
    overflow: auto;
    white-space: pre-wrap;
    word-break: break-all;
    display: none;
    position: relative;
    user-select: text;
}
.xml-block.open { display: block; }
.xml-block .xml-tag { color: #44aa44; }
.xml-block .xml-attr { color: #cccc44; }
.xml-block .xml-val { color: #5588ff; }
.xml-block .xml-text { color: #ccc; }
.xml-copy-btn {
    position: absolute; top: 4px; right: 4px;
    background: #222; border: 1px solid #444; color: #aaa;
    font-size: 10px; padding: 2px 6px; cursor: pointer; border-radius: 2px;
}
.xml-copy-btn:hover { background: #333; color: #fff; }

.th-group {
    font-size: 10px;
    color: #333;
    padding: 3px 0;
    cursor: pointer;
}
.th-group:hover { color: #555; }

.loading { color: #444; font-size: 11px; padding: 8px 0; }

/* Event count in tab label */
.event-count { color: #555; font-size: 10px; margin-left: 4px; }
</style>
</head>
<body>

<div class="topbar">
    <h1>FDIO</h1>
    <span class="status" id="status">connecting...</span>
    <div class="stats" id="stats"></div>
</div>

<div class="filterbar">
    <input type="text" class="search-box" id="search" placeholder="Search callsign, CID, airport, type, squawk, route, remarks...">
    <div class="filter-sep"></div>
    <span class="filter-label">STATUS</span>
    <select class="filter-select" id="filterStatus">
        <option value="active">Active</option>
        <option value="">All</option>
        <option value="dropped">Dropped</option>
        <option value="historical">Historical</option>
    </select>
    <span class="filter-label">FACILITY</span>
    <select class="filter-select" id="filterFacility">
        <option value="">All</option>
    </select>
    <span class="filter-label">RULES</span>
    <select class="filter-select" id="filterRules">
        <option value="">All</option>
        <option value="IFR">IFR</option>
        <option value="VFR">VFR</option>
    </select>
    <div class="filter-sep"></div>
    <span class="result-count" id="resultCount"></span>
</div>

<div class="main">
    <div class="flight-list" id="flightList">
        <div class="col-header" id="colHeader">
            <span data-col="callsign" class="sorted">CALLSIGN</span>
            <span data-col="aircraftType">TYPE</span>
            <span data-col="origin">DEP</span>
            <span data-col="destination">ARR</span>
            <span data-col="assignedAltitude">ALT</span>
            <span data-col="interimAltitude">INT</span>
            <span data-col="flightRules">FR</span>
            <span data-col="controllingFacility">SECTOR</span>
            <span data-col="squawk">SQK</span>
            <span data-col="dataLinkCode">DL</span>
            <span>ST</span>
        </div>
        <div id="rows"></div>
    </div>

    <div class="detail-panel collapsed" id="detailPanel">
        <div class="detail-header">
            <span class="cs-big" id="detailCallsign"></span>
            <span class="type-badge" id="detailType"></span>
            <span class="status-badge" id="detailStatus"></span>
            <span class="detail-close" id="detailClose">&times;</span>
        </div>
        <div class="tab-bar">
            <div class="tab active" data-tab="plan">FLIGHT PLAN</div>
            <div class="tab" data-tab="events">EVENTS<span class="event-count" id="eventCount"></span></div>
        </div>
        <div class="detail-body" id="detailBody">
        </div>
    </div>
</div>

<script>
// ── State ────────────────────────────────────────────────────
const allFlights = new Map();
const knownFacilities = new Set();
let selectedGufi = null;
let currentDetail = null;
let activeTab = 'plan';
let expandedEvents = new Set();  // event indices with expanded XML
let xmlCache = {};               // `${gufi}:${index}` → xml string
let sortCol = 'callsign', sortAsc = true;
let searchTerm = '';
let ws = null;
let showIcao = false;
let lastIcaoText = '';

// Historical flights: retained after server purge, size-capped
const MAX_HIST_BYTES = 50 * 1024 * 1024; // 50 MB
let historicalBytes = 0;

function trimHistorical() {
    if (historicalBytes <= MAX_HIST_BYTES) return;
    const hist = [];
    for (const [gufi, f] of allFlights) {
        if (f._historical) hist.push([gufi, f._removedAt || 0, f._histBytes || 0]);
    }
    hist.sort((a, b) => a[1] - b[1]); // oldest first
    while (historicalBytes > MAX_HIST_BYTES && hist.length > 0) {
        const [gufi, , bytes] = hist.shift();
        allFlights.delete(gufi);
        historicalBytes -= bytes;
    }
}

const statusEl   = document.getElementById('status');
const statsEl    = document.getElementById('stats');
const rowsEl     = document.getElementById('rows');
const searchEl   = document.getElementById('search');
const countEl    = document.getElementById('resultCount');
const filterStatus   = document.getElementById('filterStatus');
const filterFacility = document.getElementById('filterFacility');
const filterRules    = document.getElementById('filterRules');
const detailPanel = document.getElementById('detailPanel');
const detailBody  = document.getElementById('detailBody');

// ── WebSocket ────────────────────────────────────────────────
function connect() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${proto}//${location.host}/ws`);

    ws.onopen = () => {
        statusEl.textContent = 'LIVE';
        statusEl.className = 'status ok';
    };

    ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'snapshot') {
            for (const f of msg.data) { allFlights.set(f.gufi, f); noteFacility(f); }
        } else if (msg.type === 'batch') {
            for (const f of msg.data) { allFlights.set(f.gufi, f); noteFacility(f); }
        } else if (msg.type === 'update') {
            allFlights.set(msg.data.gufi, msg.data);
            noteFacility(msg.data);
        } else if (msg.type === 'remove') {
            const rf = allFlights.get(msg.data.gufi);
            if (rf && !rf._historical) {
                rf._historical = true;
                rf._removedAt = Date.now();
                rf._histBytes = JSON.stringify(rf).length;
                historicalBytes += rf._histBytes;
                trimHistorical();
            }
        } else if (msg.type === 'stats') {
            statsEl.textContent = `${(msg.data.flights || 0).toLocaleString()} flights  ${(msg.data.rate || 0).toFixed(0)} msg/s`;
        }
        scheduleRender();
    };

    ws.onclose = () => {
        statusEl.textContent = 'DISCONNECTED';
        statusEl.className = 'status';
        if (!window.idlePaused || !window.idlePaused()) setTimeout(connect, 2000);
    };
    ws.onerror = () => ws.close();
}

function noteFacility(f) {
    if (f.reportingFacility && !knownFacilities.has(f.reportingFacility)) {
        knownFacilities.add(f.reportingFacility);
        rebuildFacilityDropdown();
    }
}

function rebuildFacilityDropdown() {
    const current = filterFacility.value;
    const sorted = [...knownFacilities].sort();
    filterFacility.innerHTML = '<option value="">All</option>' +
        sorted.map(f => `<option value="${f}"${f === current ? ' selected' : ''}>${f}</option>`).join('');
}

// ── Render (throttled) ───────────────────────────────────────
let renderPending = false;
function scheduleRender() {
    if (renderPending) return;
    renderPending = true;
    requestAnimationFrame(render);
}

function render() {
    renderPending = false;
    const fStatus = filterStatus.value;
    const fFacility = filterFacility.value;
    const fRules = filterRules.value;
    const q = searchTerm.toUpperCase();

    let filtered = [];
    let histCount = 0;
    for (const f of allFlights.values()) {
        if (f._historical) histCount++;
        if (fStatus === 'historical' && !f._historical) continue;
        if (fStatus === 'active' && (f.flightStatus !== 'ACTIVE' || f._historical)) continue;
        if (fStatus === 'dropped' && (f.flightStatus !== 'DROPPED' || f._historical)) continue;
        // fStatus === '' (All) shows everything including historical
        if (fFacility && f.reportingFacility !== fFacility) continue;
        if (fRules && f.flightRules !== fRules) continue;
        if (q && !matchesSearch(f, q)) continue;
        filtered.push(f);
    }

    filtered.sort((a, b) => {
        let va = getSortValue(a, sortCol);
        let vb = getSortValue(b, sortCol);
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
    });

    countEl.textContent = histCount > 0
        ? `${filtered.length} shown (${histCount} historical)`
        : `${filtered.length} shown`;

    const html = [];
    for (const f of filtered) {
        const sel = f.gufi === selectedGufi ? ' selected' : '';
        html.push(renderRow(f, sel));
    }
    rowsEl.innerHTML = html.join('');

    rowsEl.querySelectorAll('.flight-row').forEach(el => {
        el.addEventListener('click', () => selectFlight(el.dataset.gufi));
    });
}

function matchesSearch(f, q) {
    return (f.callsign || '').includes(q)
        || (f.computerId || '').includes(q)
        || (f.origin || '').includes(q)
        || (f.destination || '').includes(q)
        || (f.aircraftType || '').includes(q)
        || (f.squawk || '').includes(q)
        || (f.route || '').toUpperCase().includes(q)
        || (f.controllingFacility || '').includes(q)
        || (f.registration || '').toUpperCase().includes(q)
        || (f.remarks || '').toUpperCase().includes(q);
}

function getSortValue(f, col) {
    switch (col) {
        case 'callsign': return f.callsign || '';
        case 'aircraftType': return f.aircraftType || '';
        case 'origin': return f.origin || '';
        case 'destination': return f.destination || '';
        case 'assignedAltitude': return f.assignedAltitude || 0;
        case 'interimAltitude': return f.interimAltitude || 0;
        case 'flightRules': return f.flightRules || '';
        case 'controllingFacility': return (f.controllingFacility || '') + (f.controllingSector || '');
        case 'squawk': return f.squawk || '';
        case 'dataLinkCode': return f.dataLinkCode && f.dataLinkCode.includes('J') ? 0 : 1;
        default: return '';
    }
}

function renderRow(f, selClass) {
    const alt = fmtAlt(f);
    const altCls = f.assignedVfr ? ' vfr' : '';
    const intAlt = f.interimAltitude ? `FL${Math.round(f.interimAltitude / 100)}` : '';
    const rules = f.flightRules === 'IFR' ? 'I' : f.flightRules === 'VFR' ? 'V' : (f.flightRules || '');
    const sector = f.controllingFacility
        ? f.controllingFacility + (f.controllingSector ? '/' + f.controllingSector : '')
        : '';
    const histCls = f._historical ? ' historical' : '';
    const stCls = f._historical ? 'historical' : (f.flightStatus || '').toLowerCase();
    return `<div class="flight-row${selClass}${histCls}" data-gufi="${f.gufi}">
        <span class="cs">${f.callsign || '????'}</span>
        <span>${f.aircraftType || ''}</span>
        <span class="dep">${f.origin || ''}</span>
        <span class="arr">${f.destination || ''}</span>
        <span class="alt${altCls}">${alt}</span>
        <span class="int">${intAlt}</span>
        <span class="rules">${rules}</span>
        <span class="sector">${sector}</span>
        <span class="sqk">${f.squawk || ''}</span>
        <span class="dl ${f.dataLinkCode && f.dataLinkCode.includes('J') ? 'yes' : 'no'}">${f.dataLinkCode && f.dataLinkCode.includes('J') ? 'J' : ''}</span>
        <span class="st ${stCls}"></span>
    </div>`;
}

function fmtAlt(f) {
    if (f.assignedVfr) {
        if (f.assignedAltitude) return `VFR/${Math.round(f.assignedAltitude / 100)}`;
        return 'VFR';
    }
    if (f.blockFloor && f.blockCeiling)
        return `${Math.round(f.blockFloor / 100)}B${Math.round(f.blockCeiling / 100)}`;
    if (f.assignedAltitude) {
        const fl = Math.round(f.assignedAltitude / 100);
        return f.assignedAltitude >= 18000 ? `FL${fl}` : `${Math.round(f.assignedAltitude)}`;
    }
    return '';
}

// ── Detail panel ─────────────────────────────────────────────
async function selectFlight(gufi) {
    selectedGufi = gufi;
    expandedEvents.clear();
    xmlCache = {};
    detailPanel.classList.remove('collapsed');
    scheduleRender();

    try {
        const resp = await fetch(`/api/flights/${encodeURIComponent(gufi)}`);
        if (resp.ok) {
            currentDetail = await resp.json();
            currentDetail._purged = false;
        } else {
            // 404 — flight purged from server, use last known data from Map
            const f = allFlights.get(gufi);
            if (!f) return;
            currentDetail = Object.assign({}, f, { _purged: true, events: [] });
        }
        renderDetailHeader(currentDetail);
        renderActiveTab();
    } catch {}
}

function closeDetail() {
    selectedGufi = null;
    currentDetail = null;
    detailPanel.classList.add('collapsed');
    scheduleRender();
}

function renderDetailHeader(d) {
    document.getElementById('detailCallsign').textContent = d.callsign || '????';
    document.getElementById('detailType').textContent = [d.aircraftType, d.wakeCategory].filter(Boolean).join('/');
    const statEl = document.getElementById('detailStatus');
    if (d._purged) {
        statEl.textContent = 'HISTORICAL';
        statEl.className = 'status-badge historical';
    } else {
        statEl.textContent = d.flightStatus || '';
        statEl.className = 'status-badge ' + (d.flightStatus || '').toLowerCase();
    }
    document.getElementById('eventCount').textContent = d.events ? ` (${d.events.length})` : '';
}

function renderActiveTab() {
    if (!currentDetail) return;
    if (activeTab === 'plan') {
        detailBody.innerHTML = renderFlightPlan(currentDetail);
    } else {
        if (currentDetail._purged) {
            detailBody.innerHTML = '<div class="purge-banner">PURGED FROM SERVER &mdash; EVENT LOG UNAVAILABLE</div>';
        } else {
            detailBody.innerHTML = renderEventLog(currentDetail);
            attachEventHandlers();
        }
    }
}

// ── ICAO FPL ────────────────────────────────────────────────
function toIcao(lid) {
    if (!lid) return 'ZZZZ';
    if (lid.length >= 4) return lid.toUpperCase();
    return 'K' + lid.toUpperCase();
}

function nasToIcaoRoute(route, origin, dest) {
    if (!route) return 'DCT';
    let r = route;
    r = r.replace(/\/\d{4}$/, '');           // strip trailing /HHMM ETE
    r = r.replace(/\.\./g, ' DCT ');         // .. = direct-to
    r = r.replace(/\./g, ' ');               // . = element separator
    // Strip origin/dest ICAO codes at boundaries
    if (origin) {
        const oI = toIcao(origin);
        r = r.replace(new RegExp('^\\s*(' + origin + '|' + oI + ')\\s*'), '');
    }
    if (dest) {
        const dI = toIcao(dest);
        r = r.replace(new RegExp('\\s*(' + dest + '|' + dI + ')\\s*$'), '');
    }
    return r.replace(/\s+/g, ' ').trim() || 'DCT';
}

function buildIcaoFpl(d) {
    // Field 7: Aircraft identification
    const f7 = d.callsign || 'ZZZZ';

    // Field 8: Flight rules + type of flight (S=scheduled, N=non-scheduled, G=GA, M=military)
    const rules = d.flightRules ? d.flightRules.charAt(0).toUpperCase() : 'I';
    const ftype = /^[A-Z]{3}\d/.test(f7) ? 'S' : 'G';
    const f8 = rules + ftype;

    // Field 9: Type/Wake (FAA→ICAO wake: L→M, S→L)
    const acType = d.aircraftType || 'ZZZZ';
    const wakeMap = { J: 'J', H: 'H', L: 'M', S: 'L' };
    const wake = wakeMap[d.wakeCategory] || d.wakeCategory || 'M';
    const f9 = acType + '/' + wake;

    // Field 10: Equipment & Capabilities / Surveillance
    // 10a: COM/NAV equipment letters (concatenated, no spaces)
    let f10a = '';
    if (d.communicationCode) f10a += d.communicationCode.replace(/\s+/g, '');
    if (d.navigationCode) f10a += d.navigationCode.replace(/\s+/g, '');
    // J codes from dataLinkCode (J1-J7 = CPDLC capabilities, e.g. "J4 J5")
    if (d.dataLinkCode) {
        const jCodes = d.dataLinkCode.match(/J\d/g) || [];
        for (const jc of jCodes) { if (!f10a.includes(jc)) f10a += jc; }
    }
    if (!f10a) f10a = d.equipmentQualifier || 'S';
    // S = Standard (VOR, VHF, ILS) — always present for IFR aircraft
    if (!f10a.includes('S')) f10a = 'S' + f10a;

    // Build Field 18 PBN/NAV first so we can set R and Z in 10a
    let pbnStr = '', navStr = '';
    if (d.pbnCode) {
        // PBN/ allows up to 8 codes; additional PBN capabilities (Z1,Z2,Z5,R1,P1,M1,M2) overflow to NAV/
        const allCodes = d.pbnCode.replace(/\s+/g, '').match(/.{2}/g) || [];
        const additional = new Set(['Z1','Z2','Z5','R1','P1','M1','M2']);
        const pbnCodes = [], navCodes = [];
        for (const c of allCodes) {
            if (additional.has(c)) navCodes.push(c);
            else pbnCodes.push(c);
        }
        // If standard codes exceed 8, overflow to NAV/ too
        if (pbnCodes.length > 8) navCodes.push(...pbnCodes.splice(8));
        pbnCodes.sort();
        navCodes.sort();
        pbnStr = pbnCodes.join('');
        navStr = navCodes.join('');
    }
    const hasDAT = !!d.otherDataLink;
    const hasNAV = navStr.length > 0 || !!d.otherNavigationCapabilities;
    // R in 10a when filing PBN/ in Field 18
    if (pbnStr && !f10a.includes('R')) f10a += 'R';
    // Z in 10a when filing NAV/, COM/, or DAT/ in Field 18
    if ((hasDAT || hasNAV) && !f10a.includes('Z')) f10a += 'Z';
    // Sort alphabetically: S always first, then remaining tokens sorted
    // Tokens are letter+digit pairs (E3, J4, B1) or single letters (D, G, R, W, Z)
    {
        const tokens = f10a.match(/[A-Z]\d|[A-Z]/g) || [];
        const rest = tokens.filter(t => t !== 'S');
        rest.sort();
        f10a = 'S' + rest.join('');
    }

    // 10b: Surveillance equipment (concatenated, no spaces)
    const f10b = d.surveillanceCode ? d.surveillanceCode.replace(/\s+/g, '') : 'C';
    const f10 = f10a + '/' + f10b;

    // Field 13: Departure aerodrome + EOBT (estimated off-block time)
    const dep = toIcao(d.origin);
    let depTime = '0000';
    if (d.actualDepartureTime) {
        const dt = new Date(d.actualDepartureTime);
        depTime = String(dt.getUTCHours()).padStart(2, '0') +
                  String(dt.getUTCMinutes()).padStart(2, '0');
    }
    const f13 = dep + depTime;

    // Field 15: Cruising speed + level + route
    // Use filed airspeed (requestedSpeed) for ICAO FPL, not ground speed
    let speed = 'N0000';
    if (d.requestedSpeed) {
        speed = 'N' + String(Math.round(d.requestedSpeed)).padStart(4, '0');
    } else if (d.groundSpeed) {
        speed = 'N' + String(Math.round(d.groundSpeed)).padStart(4, '0');
    }
    let level = 'F000';
    if (d.assignedVfr) {
        level = 'VFR';
        if (d.assignedAltitude) level += '/' + String(Math.round(d.assignedAltitude / 100)).padStart(3, '0');
    } else if (d.blockFloor && d.blockCeiling) {
        level = 'F' + String(Math.round(d.blockFloor / 100)).padStart(3, '0') +
                'F' + String(Math.round(d.blockCeiling / 100)).padStart(3, '0');
    } else if (d.assignedAltitude) {
        if (d.assignedAltitude >= 18000) {
            level = 'F' + String(Math.round(d.assignedAltitude / 100)).padStart(3, '0');
        } else {
            level = 'A' + String(Math.round(d.assignedAltitude / 100)).padStart(3, '0');
        }
    }
    // Use original (filed) route for ICAO FPL, fall back to current
    const routeSource = d.originalRoute || d.route;
    const route = nasToIcaoRoute(routeSource, d.origin, d.destination);
    const f15 = speed + level + ' ' + route;

    // Field 16: Destination + ETE + alternate(s)
    const dest = toIcao(d.destination);
    let eet = '0000';
    if (d.eta && d.actualDepartureTime) {
        const diffMin = Math.round((new Date(d.eta) - new Date(d.actualDepartureTime)) / 60000);
        if (diffMin > 0 && diffMin < 6000) {
            eet = String(Math.floor(diffMin / 60)).padStart(2, '0') +
                  String(diffMin % 60).padStart(2, '0');
        }
    }
    // Alternate aerodrome(s) from SFDPS <arrivalAerodromeAlternate code="KMIA"/>
    let altnStr = '';
    if (d.alternateAerodrome) {
        altnStr = ' ' + d.alternateAerodrome.split(' ').map(a => toIcao(a)).join(' ');
    }
    const f16 = dest + eet + altnStr;

    // Field 18: Other information (per FAA FPL Quick Guide)
    const f18 = [];
    if (pbnStr) f18.push('PBN/' + pbnStr);
    // NAV/: PBN overflow codes + otherNavigationCapabilities from FIXM
    const navParts = [];
    if (navStr) navParts.push(navStr);
    if (d.otherNavigationCapabilities) navParts.push(d.otherNavigationCapabilities);
    if (navParts.length) f18.push('NAV/' + navParts.join(' '));
    if (hasDAT) f18.push('DAT/' + d.otherDataLink.trim());
    // SUR/: from FIXM <surveillance otherSurveillanceCapabilities="...">
    // AAL Airbus flights file codes concatenated (260BC2I0 CANMANDATE) but SFDPS
    // spaces them out. Concatenate codes only for AAL+Airbus; keep raw for everyone else.
    if (d.otherSurveillanceCapabilities) {
        const isAalAirbus = /^AAL/.test(d.callsign || '') && /^A\d/.test(d.aircraftType || '');
        let sur = d.otherSurveillanceCapabilities.trim();
        if (isAalAirbus) {
            const surTokens = sur.split(/\s+/);
            sur = ''; let needSpace = false;
            for (const t of surTokens) {
                const isCode = /\d/.test(t);
                if (!isCode && sur) needSpace = true;
                if (needSpace) sur += ' ';
                sur += t;
                needSpace = !isCode;
            }
        }
        f18.push('SUR/' + sur);
    }
    // DOF: date of flight (YYMMDD)
    if (d.actualDepartureTime) {
        const dt = new Date(d.actualDepartureTime);
        const dof = String(dt.getUTCFullYear() % 100).padStart(2, '0') +
                    String(dt.getUTCMonth() + 1).padStart(2, '0') +
                    String(dt.getUTCDate()).padStart(2, '0');
        f18.push('DOF/' + dof);
    }
    if (d.registration) f18.push('REG/' + d.registration);
    // EET/: estimated elapsed times to FIR boundaries
    if (d.estimatedElapsedTimes) f18.push('EET/' + d.estimatedElapsedTimes);
    // OPR/: operating organization name from SFDPS <operator><organization name="...">
    if (d.operator) f18.push('OPR/' + d.operator);
    // ORGN/: originator AFTN address from SFDPS <originator><aftnAddress>
    if (d.originator) f18.push('ORGN/' + d.originator);
    if (d.selcal) f18.push('SEL/' + d.selcal);
    if (d.modeSCode) f18.push('CODE/' + d.modeSCode);
    if (d.remarks) f18.push('RMK/' + d.remarks.replace(/\|/g, '').trim());
    const f18str = f18.length > 0 ? f18.join(' ') : '0';

    // Format per FAA ICAO FPL Quick Guide
    return `(FPL-${f7}-${f8}\n-${f9}-${f10}\n-${f13}\n-${f15}\n-${f16}\n-${f18str})`;
}

function buildSimBriefUrl(d) {
    const p = new URLSearchParams();
    // 3-letter ICAO airline + alphanumeric fltnum (AAL123, BAW12AB)
    // Otherwise everything goes into fltnum (N123AB, BLOCKED, etc.)
    const cs = d.callsign || '';
    const csMatch = cs.match(/^([A-Z]{3})([A-Z0-9]+)$/);
    if (csMatch) {
        p.set('airline', csMatch[1]);
        p.set('fltnum', csMatch[2]);
    } else if (cs) {
        p.set('fltnum', cs);
    }
    if (cs) p.set('callsign', cs);
    // Aircraft
    if (d.aircraftType) p.set('type', d.aircraftType);
    // Airports (already ICAO in SFDPS)
    if (d.origin) p.set('orig', d.origin);
    if (d.destination) p.set('dest', d.destination);
    if (d.alternateAerodrome) {
        const altns = d.alternateAerodrome.split(' ').filter(Boolean);
        if (altns[0]) p.set('altn', altns[0]);
    }
    // Route (NAS → ICAO cleaned)
    const routeSource = d.originalRoute || d.route;
    if (routeSource) {
        const r = nasToIcaoRoute(routeSource, d.origin, d.destination);
        if (r && r !== 'DCT') p.set('route', r);
    }
    // Altitude
    if (d.assignedAltitude && !d.assignedVfr) {
        p.set('fl', String(Math.round(d.assignedAltitude / 100)));
    }
    if (d.assignedVfr) p.set('flightrules', 'v');
    // Registration & Mode S
    if (d.registration) p.set('reg', d.registration);
    if (d.modeSCode) p.set('hexcode', d.modeSCode);
    // Equipment (acdata JSON for equip/transponder/pbn/extrarmk)
    const acdata = {};
    const wakeMap = { J: 'J', H: 'H', L: 'M', S: 'L' };
    if (d.wakeCategory) acdata.cat = wakeMap[d.wakeCategory] || d.wakeCategory;
    // Build equipment and transponder strings from ICAO FPL fields
    let equip = '';
    if (d.communicationCode) equip += d.communicationCode.replace(/\s+/g, '');
    if (d.navigationCode) equip += d.navigationCode.replace(/\s+/g, '');
    if (d.dataLinkCode) {
        const jCodes = d.dataLinkCode.match(/J\d/g) || [];
        for (const jc of jCodes) { if (!equip.includes(jc)) equip += jc; }
    }
    if (!equip) equip = d.equipmentQualifier || 'S';
    if (!equip.includes('S')) equip = 'S' + equip;
    acdata.equip = equip;
    if (d.surveillanceCode) acdata.transponder = d.surveillanceCode.replace(/\s+/g, '');
    if (d.pbnCode) acdata.pbn = 'PBN/' + d.pbnCode.replace(/\s+/g, '');
    // Extra remarks (DAT, SUR, etc.)
    const extra = [];
    if (d.otherDataLink) extra.push('DAT/' + d.otherDataLink.trim());
    if (d.otherSurveillanceCapabilities) extra.push('SUR/' + d.otherSurveillanceCapabilities.trim());
    if (extra.length) acdata.extrarmk = extra.join(' ');
    if (Object.keys(acdata).length) p.set('acdata', JSON.stringify(acdata));
    // Remarks (Field 18 RMK/ → extrarmk, not dispatch remarks)
    if (d.remarks) p.set('extrarmk', 'RMK/' + d.remarks.replace(/\|/g, '').trim());
    p.set('units', 'LBS');
    return 'https://dispatch.simbrief.com/options/custom?' + p.toString();
}

function toggleIcaoFpl() {
    showIcao = !showIcao;
    renderActiveTab();
}

function copyIcaoFpl(ev) {
    ev.stopPropagation();
    navigator.clipboard.writeText(lastIcaoText).then(() => {
        ev.target.textContent = 'COPIED';
        setTimeout(() => { ev.target.textContent = 'COPY'; }, 1500);
    });
}

function renderFlightPlan(d) {
    const routeHtml = d.route
        ? `<div class="section"><h3>ROUTE</h3><div class="route-text">${esc(d.route)}</div></div>`
        : '';
    const purgeBanner = d._purged
        ? '<div class="purge-banner">PURGED FROM SERVER &mdash; SHOWING LAST KNOWN DATA</div>'
        : '';

    // ICAO FPL toggle
    lastIcaoText = buildIcaoFpl(d);
    const icaoHtml = showIcao
        ? `<div class="icao-block"><button class="icao-copy" onclick="copyIcaoFpl(event)">COPY</button>${esc(lastIcaoText).replace(/\n/g, '<br>')}</div>`
        : '';
    const icaoBtn = `<button class="icao-btn" onclick="toggleIcaoFpl()">${showIcao ? 'HIDE ICAO FPL' : 'ICAO FPL'}</button>`;
    const sbUrl = buildSimBriefUrl(d);
    const sbBtn = `<a class="icao-btn simbrief-btn" href="${esc(sbUrl)}" target="_blank" rel="noopener">SIMBRIEF</a>`;

    return `${purgeBanner}${icaoBtn}${sbBtn}${icaoHtml}
        ${section('Identity', [
            ['Callsign', d.callsign],
            ['Aircraft Type', d.aircraftType],
            ['Registration', d.registration],
            ['Wake Category', d.wakeCategory],
            ['Mode S', d.modeSCode],
            ['Equipment', d.equipmentQualifier],
            ['CID', fmtCids(d)],
            ['GUFI', d.gufi],
        ])}
        ${section('Flight Plan', [
            ['Origin', d.origin],
            ['Destination', d.destination],
            ['Flight Rules', d.flightRules],
            ['STAR', d.star],
            ['Remarks', d.remarks, d.remarks ? 'warn' : ''],
        ])}
        ${routeHtml}
        ${d.originalRoute && d.originalRoute !== d.route
            ? `<div class="section"><h3>ORIGINAL ROUTE</h3><div class="route-text">${esc(d.originalRoute)}</div></div>`
            : ''}
        ${section('Altitude', [
            ['Assigned', d.assignedAltitude ? fmtAltDetail(d) : null, 'hl'],
            ['Interim', d.interimAltitude ? `FL${Math.round(d.interimAltitude / 100)} (${Math.round(d.interimAltitude)} ft)` : null, 'warn'],
            ['Reported', d.reportedAltitude ? `FL${Math.round(d.reportedAltitude / 100)}` : null],
        ])}
        ${section('Position', [
            ['Latitude', d.latitude?.toFixed(4)],
            ['Longitude', d.longitude?.toFixed(4)],
            ['Ground Speed', d.groundSpeed ? Math.round(d.groundSpeed) + ' kt' : null],
        ])}
        ${section('Ownership', [
            ['Reporting', d.reportingFacility, 'accent'],
            ['Controlling', d.controllingFacility ? d.controllingFacility + (d.controllingSector ? '/' + d.controllingSector : '') : null, 'accent'],
            ['Handoff', d.handoffEvent ? `${d.handoffEvent}: ${d.handoffTransferring || '?'} \u2192 ${d.handoffReceiving || '?'}` : null, 'accent'],
            ['Accepting', d.handoffAccepting],
            ['Point-out', d.pointoutOriginatingUnit ? `${d.pointoutOriginatingUnit} \u2192 ${d.pointoutReceivingUnit || '?'}` : null],
        ])}
        ${section('Beacon', [
            ['Squawk', d.squawk],
            ['Assigned Sqk', d.assignedSquawk],
        ])}
        ${section('Clearance', [
            ['Heading', d.clearanceHeading],
            ['Speed', d.clearanceSpeed],
            ['Text', d.clearanceText],
        ])}
        ${section('Datalink', [
            ['Data Link', d.dataLinkCode, d.dataLinkCode?.includes('J') ? 'accent' : ''],
            ['Other', d.otherDataLink],
            ['Comm Code', d.communicationCode],
            ['SELCAL', d.selcal],
        ])}
        ${section('Times', [
            ['Dep Time', d.actualDepartureTime ? fmtTime(d.actualDepartureTime) : null],
            ['ETA', d.eta ? fmtTime(d.eta) : null],
            ['Coord Time', d.coordinationTime ? fmtTime(d.coordinationTime) : null],
            ['Coord Fix', d.coordinationFix],
        ])}
        ${section('TMI / Navigation', [
            ['TMI IDs', d.tmiIds],
            ['Nav Code', d.navigationCode],
            ['PBN Code', d.pbnCode],
            ['Surveillance', d.surveillanceCode],
        ])}
    `;
}

function renderEventLog(d) {
    if (!d.events || d.events.length === 0) {
        return '<div class="loading">No events recorded</div>';
    }

    // Show all events newest first, but group consecutive TH/HZ runs
    const events = d.events.slice().reverse();
    const html = [];
    let i = 0;
    while (i < events.length) {
        const e = events[i];
        if (e.source === 'TH' || e.source === 'HZ') {
            // Count consecutive TH/HZ
            let count = 0;
            while (i < events.length && (events[i].source === 'TH' || events[i].source === 'HZ')) {
                count++;
                i++;
            }
            html.push(`<div class="th-group" data-thgroup="1">\u2022\u2022\u2022 ${count} position update${count > 1 ? 's' : ''} \u2022\u2022\u2022</div>`);
        } else {
            const srcLc = (e.source || '').toLowerCase();
            const xmlInd = e.hasXml ? 'has-xml' : '';
            const idx = e.index;
            const isExpanded = expandedEvents.has(idx);
            const xmlKey = `${d.gufi}:${idx}`;
            const xmlHtml = isExpanded && xmlCache[xmlKey] !== undefined
                ? `<div class="xml-block open"><button class="xml-copy-btn" onclick="copyXml(event,'${xmlKey}')">Copy</button>${highlightXml(xmlCache[xmlKey])}</div>`
                : isExpanded
                ? `<div class="xml-block open"><span class="loading">Loading XML...</span></div>`
                : '';
            html.push(`<div class="event-row" data-idx="${idx}" data-hasxml="${e.hasXml ? '1' : '0'}">
                <div class="ev-line">
                    <span class="ev-time">${fmtTime(e.time)}</span>
                    <span class="ev-src ${srcLc}">${e.source}</span>
                    <span class="ev-centre">${e.centre}</span>
                    <span class="ev-summary">${esc(e.summary)}</span>
                    <span class="ev-xml-indicator ${xmlInd}">${e.hasXml ? 'XML' : ''}</span>
                </div>
                ${xmlHtml}
            </div>`);
            i++;
        }
    }

    return html.join('');
}

function attachEventHandlers() {
    detailBody.querySelectorAll('.event-row[data-idx]').forEach(el => {
        el.addEventListener('click', () => toggleEventXml(el));
    });
}

async function toggleEventXml(el) {
    const idx = parseInt(el.dataset.idx);
    const hasXml = el.dataset.hasxml === '1';
    if (!hasXml) return;

    if (expandedEvents.has(idx)) {
        expandedEvents.delete(idx);
    } else {
        expandedEvents.add(idx);
        // Fetch XML if not cached
        const key = `${selectedGufi}:${idx}`;
        if (xmlCache[key] === undefined) {
            xmlCache[key] = null; // mark as loading
            try {
                const resp = await fetch(`/api/event-xml/${idx}/${encodeURIComponent(selectedGufi)}`);
                if (resp.ok) {
                    const data = await resp.json();
                    xmlCache[key] = data.xml || '(no XML available)';
                } else {
                    xmlCache[key] = '(failed to load)';
                }
            } catch {
                xmlCache[key] = '(failed to load)';
            }
        }
    }
    // Re-render events tab
    renderActiveTab();
}

function copyXml(ev, key) {
    ev.stopPropagation();
    const xml = xmlCache[key];
    if (!xml) return;
    navigator.clipboard.writeText(xml).then(() => {
        const btn = ev.target;
        btn.textContent = 'Copied';
        setTimeout(() => btn.textContent = 'Copy', 1500);
    });
}

function highlightXml(xml) {
    if (!xml) return '<span class="xml-text">(no XML)</span>';
    // Simple XML syntax highlighting
    return esc(xml)
        .replace(/(&lt;\/?[\w:.-]+)/g, '<span class="xml-tag">$1</span>')
        .replace(/(&gt;)/g, '<span class="xml-tag">$1</span>')
        .replace(/([\w:-]+)=(&quot;[^&]*&quot;)/g, '<span class="xml-attr">$1</span>=<span class="xml-val">$2</span>')
        .replace(/([\w:-]+)=(&apos;[^&]*&apos;)/g, '<span class="xml-attr">$1</span>=<span class="xml-val">$2</span>');
}

function section(title, fields) {
    const rows = fields.filter(f => f[1] != null && f[1] !== '');
    if (rows.length === 0) return '';
    return `<div class="section"><h3>${title}</h3><div class="field-grid">
        ${rows.map(([label, value, cls]) =>
            `<span class="field-label">${label}</span><span class="field-value${cls ? ' ' + cls : ''}">${esc(String(value))}</span>`
        ).join('')}
    </div></div>`;
}

function fmtCids(d) {
    if (d.computerIds && Object.keys(d.computerIds).length > 0) {
        return Object.entries(d.computerIds).map(([fac, cid]) => `${fac}/${cid}`).join('  ');
    }
    return d.computerId || null;
}

function fmtAltDetail(d) {
    if (d.assignedVfr) {
        if (d.assignedAltitude) return `VFR/${Math.round(d.assignedAltitude / 100)}`;
        return 'VFR';
    }
    if (d.blockFloor && d.blockCeiling)
        return `${Math.round(d.blockFloor / 100)}B${Math.round(d.blockCeiling / 100)}`;
    if (d.assignedAltitude) {
        const ft = Math.round(d.assignedAltitude);
        return d.assignedAltitude >= 18000 ? `FL${Math.round(ft / 100)} (${ft} ft)` : `${ft} ft`;
    }
    return '';
}

// ── Helpers ──────────────────────────────────────────────────
function fmtTime(iso) {
    if (!iso) return '';
    try {
        const d = new Date(iso);
        return d.toISOString().substring(11, 19) + 'Z';
    } catch { return iso; }
}

function esc(s) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
}

// ── Tabs ─────────────────────────────────────────────────────
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        activeTab = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        renderActiveTab();
    });
});

// ── Close detail ─────────────────────────────────────────────
document.getElementById('detailClose').addEventListener('click', closeDetail);

// ── Sort ─────────────────────────────────────────────────────
document.getElementById('colHeader').addEventListener('click', (e) => {
    const col = e.target.dataset?.col;
    if (!col) return;
    if (sortCol === col) sortAsc = !sortAsc;
    else { sortCol = col; sortAsc = true; }
    document.querySelectorAll('.col-header span').forEach(s => s.classList.remove('sorted'));
    e.target.classList.add('sorted');
    scheduleRender();
});

// ── Filter events ────────────────────────────────────────────
let searchTimeout;
searchEl.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        searchTerm = searchEl.value.trim();
        scheduleRender();
    }, 200);
});
filterStatus.addEventListener('change', scheduleRender);
filterFacility.addEventListener('change', scheduleRender);
filterRules.addEventListener('change', scheduleRender);

// ── Auto-refresh selected flight every 3s ────────────────────
const _fdioDetailRefresh = () => { if (selectedGufi && !(currentDetail && currentDetail._purged)) fetch(`/api/flights/${encodeURIComponent(selectedGufi)}`).then(r => r.ok ? r.json() : null).then(d => { if (d) { currentDetail = d; currentDetail._purged = false; renderDetailHeader(d); renderActiveTab(); } }).catch(() => {}); };
let _fdioDetailTimer = setInterval(_fdioDetailRefresh, 3000);

window.idleOnPause = () => { if (ws) { ws.onclose = null; ws.close(); ws = null; } clearInterval(_fdioDetailTimer); };
window.idleOnResume = () => { connect(); _fdioDetailTimer = setInterval(_fdioDetailRefresh, 3000); };

// ── Init ─────────────────────────────────────────────────────
connect();
</script>
<script src="/idle-timer.js"></script>
</body>
</html>
